version: '3.8'

services:
  sync-data:
    image: python:3.11-slim
    container_name: analytics-sync
    volumes:
      - ./metabase-dashboard:/app
    working_dir: /app
    env_file:
      - .env
    networks:
      - metabase-network
    command: sh -c "pip install requests && python sync_data.py"

  metabase:
    image: metabase/metabase:latest
    container_name: metabase-local
    volumes:
      - ./metabase-data:/metabase-data
      - ./metabase-dashboard:/shared-data
    environment:
      - MB_DB_TYPE=h2
      - MB_DB_FILE=/metabase-data/metabase.db
      - MB_SITE_URL=http://localhost:3000
    ports:
      - "3000:3000"
    networks:
      - metabase-network
    restart: unless-stopped
    depends_on:
      sync-data:
        condition: service_completed_successfully

networks:
  metabase-network:
    driver: bridge
